const axios = require('axios')

const getAxiosInstance = (
    db, 
    setToken = (token) => null
) => {
    const instance = axios.create({})

    instance.interceptors.request.use(config => {
        config.headers['from_module_sdk'] = 'true'
        return config
    })
    
    instance.interceptors.response.use(
        async (response) => {
            try {
                if (response.headers.tokenrefreshed && process.env.RUNTIME_PLATFORM !== 'CLOUD') {
                    const accessToken = response.headers.maya_access_token
                    const refreshToken = response.headers.maya_refresh_token
                    
                    const tokenBlock = db.block(`tokens/mayaTokens/JWT`)
                    await tokenBlock.lockAndSet({
                        accessToken,
                        refreshToken,
                        timestamp: Date.now()
                    })
    
                    setToken(accessToken)
                }
            } catch (e) {
                console.log('Error setting maya JWT back', e)
            }

            return response
        }
    )

    return instance
}

module.exports = getAxiosInstance